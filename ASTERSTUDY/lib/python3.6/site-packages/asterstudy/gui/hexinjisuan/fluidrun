echo 开始流体计算
unset PATH
PATH=/opt/skyformai/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/usr/sw-cluster/slurm-16.05.3/bin:/usr/sw-cluster/mpi2/bin:/usr/sw-mpp/bin:/usr/sw-slurm/slurm-16.05.3/bin
unset LIBRARY_PATH
unset LD_LIBRARY_PATH
unset CPLUS_INCLUDE_PATH
unset PKG_CONFIG_PATH

currentpath=$1

echo $currentpath
cd $currentpath

# jobid=$2
# echo 正尝试重新连接:$jobid

finishtime=$3
starttime=$4

source ~/.bashrc

module load x86/Intel_Development_Tool/2018

GCCPATH=/home/export/online3/amd_share/gcc5.4
export PATH=$GCCPATH/gcc-5.4.0/x86Install/bin:${PATH}
export LD_LIBRARY_PATH=$GCCPATH/gcc-5.4.0/x86Install/lib64:${LD_LIBRARY_PATH}
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$GCCPATH/gmp-4.2.4/lib:$GCCPATH/mpc-0.8.2/SWInstall/lib:$GCCPATH/mpfr-2.4.2/SWInstall/lib

BOOST_ROOT=/home/export/online3/amd_share/precicerequirement/boost169
export LIBRARY_PATH=$BOOST_ROOT/lib:${LIBRARY_PATH};
export LD_LIBRARY_PATH=$BOOST_ROOT/lib:${LD_LIBRARY_PATH};
export CPLUS_INCLUDE_PATH=$BOOST_ROOT/include:${CPLUS_INCLUDE_PATH};

export LD_LIBRARY_PATH=/home/export/online3/amd_share/precicerequirement/yamlcpp062/lib:${LD_LIBRARY_PATH}
export CPLUS_INCLUDE_PATH=/home/export/online3/amd_share/precicerequirement/yamlcpp062/include:$CPLUS_INCLUDE_PATH

export Eigen3_ROOT=/home/export/online3/amd_share/precicerequirement/eigen-eigen-323c052e1731

export PATH=/home/export/online3/amd_share/precicerequirement/cmake/bin:${PATH};

PRECICE_ROOT=/home/export/online3/amd_share/precicerequirement/preCICE1.6.1
export PKG_CONFIG_PATH=$PRECICE_ROOT/lib/pkgconfig
export LIBRARY_PATH=$PRECICE_ROOT/lib:${LIBRARY_PATH};
export LD_LIBRARY_PATH=$PRECICE_ROOT/lib:${LD_LIBRARY_PATH};
export CPLUS_INCLUDE_PATH=$PRECICE_ROOT/include:${CPLUS_INCLUDE_PATH};

#. /home/export/online3/amd_share/OpenFOAM_x86/OpenFOAM-5.0/etc/bashrc
. /home/export/online3/amd_share/OpenFOAM_x86/OpenFOAM-6.0/etc/bashrc

. $WM_PROJECT_DIR/bin/tools/RunFunctions

# 1 for true, 0 for false
parallel=1
if [ "$1" = "-parallel" ]; then
    parallel=1
fi

# Prepare
if [ $parallel -eq 1 ]; then
    ln -s -f precice-config_parallel.xml precice-config.xml
else
    ln -s -f precice-config_serial.xml precice-config.xml
fi

# Run
cd Fluid
    solver=$(getApplication)
    procs=$(getNumberOfProcessors)
cd ..
echo $solver

# yes | cp -rf Fluid/constant/g_ac Fluid/constant/g
# yes | cp -rf Fluid/system/controlDict_ac Fluid/system/controlDict
# /usr/sw-mpp/bin/bsub -I -q q_x86_share -n $procs $solver -case Fluid -parallel &&

solver=interFoam

ln -s -f precice-config_parallel.xml precice-config.xml

yes | cp -rf Fluid/constant/g_ac Fluid/constant/g
yes | cp -rf Fluid/system/controlDict_ac Fluid/system/controlDict
rm -rf log.$solver
/usr/sw-mpp/bin/bsub -I -q q_x86_share -n $procs -o log.$solver $solver -parallel -case Fluid &&

# if 第一阶段执行成功,并且第二阶段还没执行过:
# echo Fluid/processor0/$starttime
# echo Fluid/processor0/$finishtime
if [[ ! -d Fluid/processor0/$starttime && -d Fluid/processor0/$finishtime ]]; then
    #切换到第二阶段precice-config.xml
    if [ $parallel -eq 1 ]; then
        ln -s -f precice-config_parallel2.xml precice-config.xml
    else
        ln -s -f precice-config_serial2.xml precice-config.xml
    fi

    #修改/切换 Fluid内的配置文件
    yes | cp -rf Fluid/constant/g_sh Fluid/constant/g
    yes | cp -rf Fluid/system/controlDict_sh Fluid/system/controlDict
    #/usr/sw-mpp/bin/bsub -I -q q_x86_share -n $procs $solver -case Fluid -parallel
    rm -rf log.$solver
    /usr/sw-mpp/bin/bsub -I -q q_x86_share -n $procs -o log.$solver $solver -case Fluid -parallel

    echo 结束！
fi

